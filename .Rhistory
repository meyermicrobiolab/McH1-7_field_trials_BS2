# Perform the center-log-ratio (CLR) transformation
d.clr <- codaSeq.clr(d.czm)
# transpose matrix of CLR transformed data for ordination and dendrogram
E.clr <- t(d.clr)
# plot compositional PCA biplot (perform a singular value decomposition)
d.pcx <- prcomp(E.clr)
# calculate percent variance explained for the axis labels
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
#biplot(d.pcx, cex=c(0.6,0.4), var.axes=F,scale=1, xlab=xlab, ylab=ylab)
summary(d.pcx)
str(d.pcx)
screeplot(d.pcx)
# replot PCA with ggplot2 (showing samples only)
df_out <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Collection.month<-factor(samples$Collection.month,levels=c("Aug","Oct","Jan"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
pdf("PCA.pdf",bg ="white",width = 8.5)
p<-ggplot(df_out,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p<-p+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
facet_grid(~samples$Collection.month)
p + labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
dev.off()
####### Perform permanova using Aitchison distance
dist.clr <- dist(E.clr)
perm<-adonis2(dist.clr~Condition*Treatment,as(sample_data(ps5_BS2),"data.frame"))
print(perm)
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2_aug.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2_aug.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2_aug.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2_aug <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2_aug  #755 taxa and 60 samples
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
d.clr <- codaSeq.clr(d.czm)
E.clr <- t(d.clr)
d.pcx <- prcomp(E.clr)
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
df_out.aug <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
pdf("PCA_Aug.pdf",bg ="white",width = 8.5)
p1<-ggplot(df_out.aug,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p1<-p1+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
p1
dev.off()
# Perform permanova using Aitchison distance
dist.clr <- dist(E.clr)
perm<-adonis2(dist.clr~Condition,as(sample_data(ps5_BS2_aug),"data.frame"))
print(perm)
pdf("PCA_Aug.pdf",bg ="white",width = 8.5)
p1<-ggplot(df_out.aug,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2_aug.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2_aug.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2_aug.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2_aug <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2_aug  #755 taxa and 60 samples
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
d.clr <- codaSeq.clr(d.czm)
E.clr <- t(d.clr)
d.pcx <- prcomp(E.clr)
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
df_out.aug <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
pdf("PCA_Aug.pdf",bg ="white",width = 8.5)
p1<-ggplot(df_out.aug,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p1<-p1+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
labs(x=xlab, y=ylab, shape="Condition",color="Treatment") +coord_fixed()
p1
dev.off()
pdf("PCA_Aug.pdf",bg ="white",width = 8.5)
p1<-ggplot(df_out.aug,aes(x=PC1,y=PC2,shape=samples$Condition,color=samples$Treatment))
p1<-p1+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
labs(x=xlab, y=ylab,shape="Condition",color="Treatment") +coord_fixed()
p1
dev.off()
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2_oct.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2_oct.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2_oct.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2_oct <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2_oct  #755 taxa and 71 samples
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
d.clr <- codaSeq.clr(d.czm)
E.clr <- t(d.clr)
d.pcx <- prcomp(E.clr)
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
df_out.oct <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
pdf("PCA_Oct.pdf",bg ="white",width = 8.5)
p2<-ggplot(df_out.oct,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p2<-p2+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
p2
dev.off()
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2_jan.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2_jan.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2_jan.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2_jan <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2_jan  #755 taxa and 63 samples
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
d.clr <- codaSeq.clr(d.czm)
E.clr <- t(d.clr)
d.pcx <- prcomp(E.clr)
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
df_out.jan <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
pdf("PCA_Jan.pdf",bg ="white",width = 8.5)
p3<-ggplot(df_out.jan,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p3<-p3+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
p3
dev.off()
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps
ps_ra<-transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps_ra
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2 <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
# Perform the center-log-ratio (CLR) transformation
d.clr <- codaSeq.clr(d.czm)
# transpose matrix of CLR transformed data for ordination and dendrogram
E.clr <- t(d.clr)
# plot compositional PCA biplot (perform a singular value decomposition)
d.pcx <- prcomp(E.clr)
# calculate percent variance explained for the axis labels
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
dist.clr <- dist(E.clr)
perm<-adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"))
print(perm)
knitr::opts_chunk$set(echo = TRUE)
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2 <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2
library(dada2)
library(ggplot2)
library(phyloseq)
library(vegan)
library(knitr)
library(CoDaSeq)
library(dplyr)
library(cowplot)
library(randomcoloR)
library(biomehorizon)
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
# Perform the center-log-ratio (CLR) transformation
d.clr <- codaSeq.clr(d.czm)
# transpose matrix of CLR transformed data for ordination and dendrogram
E.clr <- t(d.clr)
# plot compositional PCA biplot (perform a singular value decomposition)
d.pcx <- prcomp(E.clr)
# calculate percent variance explained for the axis labels
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
dist.clr <- dist(E.clr)
perm<-adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"))
print(perm)
perm<-adonis2(dist.clr~Condition*Treatment, strata=Collection.month,as(sample_data(ps5_BS2),"data.frame"))
perm<-adonis2(dist.clr~Treatment, strata = interaction(samples$Condition, samples$Collection.month),as(sample_data(ps5_BS2),"data.frame"))
print(perm)
install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(devtools)
install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)
perm2<-pairwise.adonis2(dist.clr~Treatment/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata=Collection.month)
perm2<-pairwise.adonis2(dist.clr~Treatment/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm2)
perm2<-pairwise.adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm2)
perm2<-pairwise.adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"))
print(perm2)
perm3<-pairwise.adonis2(dist.clr~Treatment/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm3)
View(samples)
ps5_BS2_DD = subset_samples(ps5_BS2, Condition == "DD")
perm4<-pairwise.adonis2(dist.clr~Treatment/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
ps5_BS2_DD
otu_ps5_BS2_DD = as(otu_table(ps5_BS2_DD), "matrix")
d.czm2 <- cmultRepl(t(otu_ps5_BS2_DD), method="CZM", label=0, z.warning=1)
d.clr2 <- codaSeq.clr(d.czm2)
E.clr2 <- t(d.clr2)
dist.clr2 <- dist(E.clr2)
perm4<-pairwise.adonis2(dist.clr2~Treatment/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
print(perm4)
View(samples)
knitr::opts_chunk$set(echo = TRUE)
perm4<-pairwise.adonis2(dist.clr2~Condition/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
library(dada2)
library(ggplot2)
library(phyloseq)
library(vegan)
library(pairwiseAdonis)
library(knitr)
library(CoDaSeq)
library(dplyr)
library(cowplot)
library(randomcoloR)
library(biomehorizon)
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
perm4<-pairwise.adonis2(dist.clr2~Condition/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
perm5<-pairwise.adonis2(dist.clr2~Condition/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
View(perm3)
print(perm2)
print(perm3)
perm3b<-pairwise.adonis2(dist.clr~Condition/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm3b)
perm5<-pairwise.adonis2(dist.clr~Condition/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm5)
print(perm)
perm<-adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"))
print(perm)
perm5<-pairwise.adonis2(dist.clr2~Treatment/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
print(perm5)
perm2<-pairwise.adonis2(dist.clr~Condition*Treatment*Collection.month,as(sample_data(ps5_BS2),"data.frame"))
print(perm2)
perm3<-pairwise.adonis2(dist.clr~Treatment/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm3)
perm4<-pairwise.adonis2(dist.clr~Condition/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm4)
perm5<-pairwise.adonis2(dist.clr~Treatment*Condition/Collection.month,as(sample_data(ps5_BS2),"data.frame"), strata='Collection.month')
print(perm5)
perm6<-pairwise.adonis2(dist.clr2~Treatment/Collection.month,as(sample_data(ps5_BS2_DD),"data.frame"), strata='Collection.month')
print(perm6)
knitr::opts_chunk$set(echo = TRUE)
library(dada2)
library(ggplot2)
library(phyloseq)
library(vegan)
library(pairwiseAdonis)
library(knitr)
library(CoDaSeq)
library(dplyr)
library(cowplot)
library(randomcoloR)
library(biomehorizon)
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
st1 <- readRDS("~/Documents/McH1-7_field_trials_BS2andBS3/cutadapt_NS2107_BS2/seqtab.rds")
st1 <- readRDS("~/Documents/GitHub/McH1-7_field_trials_BS2andBS3/cutadapt_NS2107_BS2/seqtab.rds")
st2 <- readRDS("~/Documents/GitHub/McH1-7_field_trials_BS2andBS3/cutadapt_NS2172_BS2/seqtab.rds")
st3 <- readRDS("~/Documents/GitHub/McH1-7_field_trials_BS2andBS3/cutadapt_NS2211_BS2/seqtab.rds")
st4 <- readRDS("~/Documents/GitHub/McH1-7_field_trials_BS2andBS3/cutadapt_NS2408_BS2/seqtab.rds")
st.all <- mergeSequenceTables(st1, st2, st3, st4, repeats="sum")
#Remove chimeric sequences:
seqtab.nochim <- removeBimeraDenovo(st.all, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)
# 421 samples and 26,295 taxa
sum(seqtab.nochim)/sum(st.all)
# proportion of non-chimeric taxa: 0.9640057 (4% of ASVs were removed as chimeras)
# SAVE the non-chimeric sequence variant table SO YOU DON'T HAVE TO REPEAT ALL OF THE ABOVE STEPS
saveRDS(seqtab.nochim, file="~/Documents/McH1-7_field_trials_BS2andBS3/probiotics.rds")
# SAVE the non-chimeric sequence variant table SO YOU DON'T HAVE TO REPEAT ALL OF THE ABOVE STEPS
saveRDS(seqtab.nochim, file="~/Documents/GitHub/McH1-7_field_trials_BS2andBS3/probiotics.rds")
taxa <- assignTaxonomy(seqtab.nochim, "~/Documents/GitHub/silva_nr99_v138.1_train_set.fa.gz", multithread=TRUE)
# FIX the NAs in the taxa table
taxon <- as.data.frame(taxa,stringsAsFactors=FALSE)
taxon$Phylum[is.na(taxon$Phylum)] <- taxon$Kingdom[is.na(taxon$Phylum)]
taxon$Class[is.na(taxon$Class)] <- taxon$Phylum[is.na(taxon$Class)]
taxon$Order[is.na(taxon$Order)] <- taxon$Class[is.na(taxon$Order)]
taxon$Family[is.na(taxon$Family)] <- taxon$Order[is.na(taxon$Family)]
taxon$Genus[is.na(taxon$Genus)] <- taxon$Family[is.na(taxon$Genus)]
write.table(taxon,"silva_taxa_table.txt",sep="\t",col.names=NA)
write.table(seqtab.nochim, "silva_otu_table.txt",sep="\t",col.names=NA)
otu <- read.table("silva_otu_table.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_taxa_table.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_BS2_tissueloss.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps
# remove chloroplasts and mitochondria and Eukaryota
get_taxa_unique(ps, "Family") #789
get_taxa_unique(ps, "Order") #448
get_taxa_unique(ps, "Kingdom") #3
ps <- subset_taxa(ps, Family !="Mitochondria")
ps <- subset_taxa(ps, Order !="Chloroplast")
ps <- subset_taxa(ps, Kingdom !="Eukaryota")
ps <- subset_taxa(ps, Kingdom !="NA")
get_taxa_unique(ps, "Family") #786
get_taxa_unique(ps, "Order") #446
get_taxa_unique(ps, "Kingdom") #2
ps
# Now export cleaned otu and taxa tables from phyloseq for future reference
otu = as(otu_table(ps), "matrix")
taxon = as(tax_table(ps), "matrix")
metadata = as(sample_data(ps), "matrix")
write.table(otu,"silva_nochloronomito_otu_table.txt",sep="\t",col.names=NA)
write.table(taxon,"silva_nochloronomito_taxa_table.txt",sep="\t",col.names=NA)
# export ASV table as relative abundance
ps_ra<-transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
otu_ra = as(otu_table(ps_ra), "matrix")
write.table(otu_ra,"silva_nochloronomito_otu_table_RA.txt",sep="\t",col.names=NA)
ps #25137 taxa and 421 samples
# Remove sample blanks
psnb = subset_samples(ps, Coral.tag != "blank")
psnb #25137 taxa and 410 samples
psnb <- prune_taxa(taxa_sums(psnb) > 1, psnb)
psnb #25013 taxa and 410 samples, 124 taxa only in blanks
otu_psnb = as(otu_table(psnb), "matrix")
taxon_psnb = as(tax_table(psnb), "matrix")
metadata_psnb = as(sample_data(psnb), "matrix")
write.table(otu_psnb,"silva_nochloronomito_otu_table_BS2nb.txt",sep="\t",col.names=NA)
write.table(taxon_psnb,"silva_nochloronomito_taxa_table_BS2nb.txt",sep="\t",col.names=NA)
write.table(metadata_psnb,"metadata_BS2nb.txt",sep="\t",col.names=NA)
psBS2_ra<-transform_sample_counts(psBS2, function(OTU) OTU/sum(OTU))
psBS2_ra<-transform_sample_counts(psnb, function(OTU) OTU/sum(OTU))
otu_psBS2_ra = as(otu_table(psBS2_ra), "matrix")
write.table(otu_psBS2_ra,"silva_nochloronomito_otu_table_psBS2_RA.txt",sep="\t",col.names=NA)
#explore BS2 data
ntaxa(psnb) #20105
get_taxa_unique(psnb, "Order") #427
get_taxa_unique(psnb, "Class") #185
ps5_BS2<-filter_taxa(psBS2, function(x) mean(x) >5, TRUE)
ps5_BS2<-filter_taxa(psnb, function(x) mean(x) >5, TRUE)
ntaxa(ps5_BS2) #755
get_taxa_unique(ps5_BS2, "Order") #102
get_taxa_unique(ps5_BS2, "Class") #46
otu_ps5_BS2 = as(otu_table(ps5_BS2), "matrix")
taxon_ps5_BS2 = as(tax_table(ps5_BS2), "matrix")
metadata_ps5_BS2 = as(sample_data(ps5_BS2), "matrix")
write.table(otu_ps5_BS2,"silva_nochloronomito_otu_table_ps5_BS2.txt",sep="\t",col.names=NA)
write.table(taxon_ps5_BS2,"silva_nochloronomito_taxa_table_ps5_BS2.txt",sep="\t",col.names=NA)
write.table(metadata_ps5_BS2,"metadata_ps5_BS2.txt",sep="\t",col.names=NA)
ps5_BS2_ra<-transform_sample_counts(ps5_BS2, function(OTU) OTU/sum(OTU))
otu_ps5_BS2_ra = as(otu_table(ps5_BS2_ra), "matrix")
write.table(otu_ps5_BS2_ra,"silva_nochloronomito_otu_table_ps5_BS2_RA.txt",sep="\t",col.names=NA)
ps5_BS2 #755 taxa and 194 samples
otu <- read.table("silva_nochloronomito_otu_table_ps5_BS2.txt",sep="\t",header=TRUE, row.names=1)
taxon <- read.table("silva_nochloronomito_taxa_table_ps5_BS2.txt",sep="\t",header=TRUE,row.names=1)
samples<-read.table("metadata_ps5_BS2.txt",sep="\t",header=T,row.names=1)
OTU = otu_table(otu, taxa_are_rows=FALSE)
taxon<-as.matrix(taxon)
TAX = tax_table(taxon)
sampledata = sample_data(samples)
ps5_BS2 <- phyloseq(otu_table(otu, taxa_are_rows=FALSE),
sample_data(samples),
tax_table(taxon))
ps5_BS2
d.czm <- cmultRepl(t(otu), method="CZM", label=0, z.warning=1)
# Perform the center-log-ratio (CLR) transformation
d.clr <- codaSeq.clr(d.czm)
# transpose matrix of CLR transformed data for ordination and dendrogram
E.clr <- t(d.clr)
# plot compositional PCA biplot (perform a singular value decomposition)
d.pcx <- prcomp(E.clr)
# calculate percent variance explained for the axis labels
pc1 <- round(d.pcx$sdev[1]^2/sum(d.pcx$sdev^2),2)
pc2 <- round(d.pcx$sdev[2]^2/sum(d.pcx$sdev^2),2)
xlab <- paste("PC1: ", pc1, sep="")
ylab <- paste("PC2: ", pc2, sep="")
summary(d.pcx)
str(d.pcx)
screeplot(d.pcx)
df_out <- as.data.frame(d.pcx$x)
theme_set(theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()))
cols<-c("resistant"="#000000","none"="#999999","probiotic paste"="#D55E00","probiotic bag"="#E69F00","control paste"="#0072B2","control bag"="#56B4E9")
samples$Treatment<-factor(samples$Treatment,levels=c("probiotic bag","probiotic paste","control bag","control paste","none","resistant"))
samples$Collection.month<-factor(samples$Collection.month,levels=c("Aug","Oct","Jan"))
samples$Condition<-factor(samples$Condition,levels=c("HH","HD","DD"))
p<-ggplot(df_out,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p<-p+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
facet_grid(~samples$Collection.month)
p + labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
pdf("PCA.pdf",bg ="white",width = 8.5)
p<-ggplot(df_out,aes(x=PC1,y=PC2,color=samples$Treatment,shape=samples$Condition))
p<-p+geom_point(size=2)+
theme(axis.title = element_text(size=14))+
theme(axis.text=element_text(size=12))+
theme(legend.title = element_text(size=14))+
theme(legend.text = element_text(size=12))+
theme(strip.text.x = element_text(size=12))+
scale_color_manual(values=cols)+
guides(fill = guide_legend(override.aes=list(shape=21)))+
facet_grid(~samples$Collection.month)
p + labs(x=xlab, y=ylab, color="Treatment",shape="Condition") +coord_fixed()
dev.off()
